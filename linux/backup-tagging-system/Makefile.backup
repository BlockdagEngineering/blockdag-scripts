# Load generated tag if it exists
-include generated-tag.env

# Variables
IMAGE_NAME=blockdagnetwork/primordial
LOCAL_TAG=dev
REMOTE_TAG=$(NEW_TAG)

.PHONY: all calculate-tag build tag push clean

# Default target
all: calculate-tag build tag push

# Calculate next Docker tag based on DockerHub state
calculate-tag:
	./scripts/calculate-next-tag.sh

# Build the Docker image locally
build:
	docker build -t blockdag-node:$(LOCAL_TAG) .

# Tag the image for DockerHub
tag:
	docker tag blockdag-node:$(LOCAL_TAG) $(IMAGE_NAME):$(REMOTE_TAG)

# Push the tagged image to DockerHub
push:
	docker push $(IMAGE_NAME):$(REMOTE_TAG)

# Optional: Clean up local images
clean:
	docker rmi blockdag-node:$(LOCAL_TAG) || truem
	docker rmi $(IMAGE_NAME):$(REMOTE_TAG) || true
